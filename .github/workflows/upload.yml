name: YouTube Video Upload

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours max for large batches
    
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ“‹ Check Files
        run: |
          echo "ðŸ“‹ Checking required files..."
          
          if [ ! -f "youtube_token.pickle" ]; then
            echo "âŒ youtube_token.pickle not found!"
            exit 1
          fi
          
          if [ ! -f "videos.txt" ]; then
            echo "âŒ videos.txt not found!"
            exit 1
          fi
          
          if [ ! -f "uploader.py" ]; then
            echo "âŒ uploader.py not found!"
            exit 1
          fi
          
          echo "âœ… All required files present"
          
          echo ""
          echo "ðŸ“¹ Video Links Count:"
          grep -v '^#' videos.txt | grep -v '^$' | wc -l
          
          echo ""
          echo "ðŸ“‚ Repository Files:"
          ls -lh
      
      - name: ðŸš€ Run Upload (All Videos)
        run: |
          echo "ðŸŽ¬ Starting upload process..."
          echo "ðŸ“Œ Will upload ALL remaining videos"
          echo ""
          python uploader.py
        env:
          PYTHONUNBUFFERED: 1
      
      - name: ðŸ’¾ Save Progress
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: upload-tracker
          path: |
            tracker.json
            ip_log_*.txt
          retention-days: 90
      
      - name: ðŸ“Š Upload Summary
        if: always()
        run: |
          echo "## ðŸ“Š Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "tracker.json" ]; then
            echo "### Progress:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat tracker.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No tracker file found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Upload complete!" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Commit Progress (Optional)
        if: success()
        continue-on-error: true
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f "tracker.json" ]; then
            git add tracker.json
            git diff --staged --quiet || git commit -m "ðŸ“Š Update upload progress [skip ci]"
            git push
          fi
